<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>配置管理</title>
  <!-- 引入共享样式 -->
  <link rel="stylesheet" href="/static/shared-styles.css">
  <script src="/static/shared.js"></script>
</head>

<body>
  <h1>配置管理</h1>

  <div class="container">
    <div class="form-group">
      <label>路径:</label>
      <select id="path">
        <option value="/">根路径 (/)</option>
        <option value="/logs">日志页面 (/logs)</option>
        <option value="/config">配置页面 (/config)</option>
        <option value="/tokeninfo">Token 信息页面 (/tokeninfo)</option>
        <option value="/static/shared-styles.css">共享样式 (/static/shared-styles.css)</option>
        <option value="/static/shared.js">共享脚本 (/static/shared.js)</option>
      </select>
    </div>

    <div class="form-group">
      <label>内容类型:</label>
      <select id="content_type">
        <option value="default">默认行为</option>
        <option value="text">纯文本</option>
        <option value="html">HTML</option>
      </select>
    </div>

    <div class="form-group">
      <label>内容:</label>
      <textarea id="content"></textarea>
    </div>

    <div class="form-group">
      <label>图片处理能力:</label>
      <select id="vision_ability">
        <option value="">保持不变</option>
        <option value="none">禁用</option>
        <option value="base64">仅 Base64</option>
        <option value="base64-http">Base64 + HTTP</option>
      </select>
    </div>

    <div class="form-group">
      <label>慢速池:</label>
      <select id="enable_slow_pool">
        <option value="">保持不变</option>
        <option value="true">启用</option>
        <option value="false">禁用</option>
      </select>
    </div>

    <div class="form-group">
      <label>认证令牌:</label>
      <input type="password" id="authToken">
    </div>

    <div class="button-group">
      <button onclick="updateConfig('get')">获取配置</button>
      <button onclick="updateConfig('update')">更新配置</button>
      <button onclick="updateConfig('reset')" class="secondary">重置配置</button>
    </div>
  </div>

  <div id="result" class="message"></div>

  <script>
    async function fetchConfig() {
      const data = await makeAuthenticatedRequest('/config', {
        body: JSON.stringify({ action: 'get' })
      });

      if (data) {
        const path = document.getElementById('path').value;
        let content = '';

        // 根据不同路径获取对应内容
        const contentMap = {
          '/': data.data.root_content,
          '/logs': data.data.logs_content,
          '/config': data.data.config_content,
          '/tokeninfo': data.data.tokeninfo_content,
          '/static/shared-styles.css': data.data.shared_styles_content,
          '/static/shared.js': data.data.shared_js_content
        };

        const pageContent = contentMap[path];

        // 如果是 Default 类型，需要从路径获取内容
        if (pageContent?.type === 'Default') {
          // 直接从路径获取内容
          const response = await fetch(path);
          content = await response.text();
        } else if (pageContent?.type === 'Text' || pageContent?.type === 'Html') {
          content = pageContent.content;
        }

        // 更新表单
        document.getElementById('content').value = content || '';
        document.getElementById('content_type').value = pageContent?.type?.toLowerCase() || 'default';
        document.getElementById('vision_ability').value = data.data.vision_ability || '';
        document.getElementById('enable_slow_pool').value =
          data.data.enable_slow_pool === null ? '' : data.data.enable_slow_pool.toString();
      }
    }

    async function updateConfig(action) {
      if (action === 'get') {
        await fetchConfig();
        return;
      }

      const data = {
        action,
        path: document.getElementById('path').value,
        content_type: action === 'update' ? document.getElementById('content_type').value : undefined,
        content: action === 'update' ? document.getElementById('content').value : '',
        ...(document.getElementById('vision_ability').value && {
          vision_ability: document.getElementById('vision_ability').value
        }),
        ...(document.getElementById('enable_slow_pool').value && {
          enable_slow_pool: document.getElementById('enable_slow_pool').value === 'true' || null
        })
      };

      const result = await makeAuthenticatedRequest('/config', {
        body: JSON.stringify(data)
      });

      if (result) {
        showMessage('result', result.message, false);
        if (action === 'update' || action === 'reset') {
          await fetchConfig();
        }
      }
    }

    function showSuccess(message) {
      showMessage('result', message, false);
    }

    function showError(message) {
      showMessage('result', message, true);
    }

    // 添加按钮事件监听
    document.getElementById('path').addEventListener('change', fetchConfig);

    // 更新内容类型变更处理
    document.getElementById('content_type').addEventListener('change', function () {
      const textarea = document.getElementById('content');
      textarea.disabled = this.value === 'default';
    });

    // 初始化 token 处理
    initializeTokenHandling('authToken');
  </script>
</body>

</html>